<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="description" content="View the history of a Minecraft world, hour by hour, using its advancements!">
    <meta name="keywords" content="Minecraft">
    <meta name="author" content="AnonUserGuy">

    <meta property="og:title" content="Advancement Timeline Generator">
    <meta property="og:description" content="View the history of a Minecraft world, hour by hour, using its advancements!">
    <meta property="og:image" content="https://anonuserguy.github.io/media/images/revenge.jpg" />
    <meta property="og:url" content="https://anonuserguy.github.io/advancement_timeline/">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Advancement Timeline Generator</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style id="generatedStyles"></style>
    <script src="../js/global.js"></script>

    <script src="../js/get_minecraft_usernames_from_uuids.js"></script>
</head>

<body>
    <div>
        <div>
            <a href="../">&lt-- go back</a>
        </div>
        <div class="right-button">
            <label for="exampleCountInput">
                <input id="exampleInput" type="button" value="add example player(s)" />
            </label>
            <input id="exampleCountInput" type="number" aria-label="example player count" min="1" max="999" value="1" />
        </div>
    </div>

    <div class="section">
        <p>
            Within a Minecraft world folder, locate the "advancement" subfolder and upload ALL files within it to get
            your advancement timeline for that world!
        </p>
        <input id="uploadInput" type="file" accept="application/json" multiple />
        <input id="resetInput" type="button" value="reset timeline" />
    </div>

    <div class="section-timeline" id="timelineDivOuter" hidden>
        <div id="timelineDiv"></div>
    </div>

    <div>
        <p>
            <a href="https://youtu.be/cPJUBQd-PNM" target="_blank">
                <img src="../media/images/revenge.jpg" alt="revenge minecraft music video" height="120">
            </a>
        </p>
        <p>brought to you by <i>Minecraft!</i></p>
    </div>

    <script>
        const bigMargin = 53;
        const DateTimeFormat = new Intl.DateTimeFormat(undefined, {
            dateStyle: "short",
            timeStyle: "long"
        });
        const DateFormat = new Intl.DateTimeFormat(undefined, {
            dateStyle: "full"
        });
        const uploadInput = document.getElementById("uploadInput");
        const resetInput = document.getElementById("resetInput");
        const exampleInput = document.getElementById("exampleInput");
        const exampleCountInput = document.getElementById("exampleCountInput");
        const timelineDivOuter = document.getElementById("timelineDivOuter");
        const timelineDiv = document.getElementById("timelineDiv");
        const styleEl = document.getElementById("generatedStyles");

        let timeline = [];
        const profiles = [];

        function promiseFileAsText(file) {
            const reader = new FileReader();

            return new Promise((resolve, reject) => {
                reader.onload = () => {
                    resolve(reader.result)
                }
                reader.onerror = () => {
                    reader.abort();
                    reject()
                }
                reader.readAsText(file);
            });
        }
        function removeDuplicateEvents(arr) {
            for (let i = 0; i < arr.length - 1; i++) {
                let j = i + 1;
                while (j < arr.length && eventsAreDuplicates(arr[i], arr[j])) {
                    j++;
                }
                if (j !== i + 1) {
                    arr.splice(i + 1, j - i - 1);
                }
            }
        }
        function eventsAreDuplicates(event1, event2) {
            return event1[0].getTime() === event2[0].getTime() && event1[1] === event2[1] && event1[2] === event2[2];
        }
        function sameDay(d1, d2) {
            return d1.getDate() === d2.getDate() &&
                d1.getMonth() === d2.getMonth() &&
                d1.getFullYear() === d2.getFullYear();
        }

        uploadInput.addEventListener("change", async () => {
            loading(true);
            await updateTimeline();
            timelinePrint();
            loading(false);
        });

        resetInput.addEventListener("click", () => {
            timelineDivOuter.setAttribute("hidden", "");
            timelineDiv.replaceChildren();
            timeline = [];
        });

        exampleInput.addEventListener("click", () => {
            addRandomPlayers(exampleCountInput.value);
            timelinePrint();
        });

        function addRandomPlayers(amount) {
            const MAX_UNIX_TIME = 8640000000000000;
            const minDate = timeline.length ? timeline[0][0] : new Date(Math.random() * MAX_UNIX_TIME);
            const maxDate = timeline.length ? timeline[timeline.length - 1][0] : new Date(minDate.getTime() + 1000 * 60 * 60 * 24 * 4);

            for (let h = 0; h < amount; h++) {
                const profileIndex = profiles.length;
                profiles.push({
                    uuid: "none!",
                    username: `demo${profileIndex}`,
                    nameless: false,
                    generated: true
                })

                const eventCount = Math.random() * 100 + 1;
                for (let i = 0; i < eventCount;) {

                    const concurrentEventCount = Math.max(Math.random() * 20 - 15, 1);
                    const date = randomDateInRange(minDate, maxDate);
                    for (let j = 0; j < concurrentEventCount && i < eventCount; j++) {
                        timeline.push([date, profileIndex, `event${i}`]);
                        i++;
                    }
                }
            }
            timeline.sort((a, b) => a[0] - b[0]);
        }

        function randomDateInRange(from, to) {
            return new Date(from.getTime() + Math.random() * (to.getTime() - from.getTime()));
        }

        async function updateTimeline() {
            const files = Array.from(uploadInput.files);

            const uuids = files.map(file => file.name.replace(/(.*)\..*/, "$1"));
            const usernamesPromise = getMinecraftUsernamesFromUuids(uuids).then((usernames) => {
                for (let i = 0; i < usernames.length; i++) {
                    const profile = profiles[profileIndices[i]];
                    profile.username = usernames[i] || `<user #${profileIndices[i]}>`;
                    profile.nameless = !usernames[i];
                }
            });
            const profileIndices = [];
            for (let i = 0; i < uuids.length; i++) {
                let profileIndex = profiles.findIndex(profile => profile.uuid === uuids[i]);
                if (profileIndex === -1) {
                    profileIndex = profiles.length;
                    profiles.push({
                        uuid: uuids[i],
                        generated: false
                    });
                }
                profileIndices[i] = profileIndex;
            }

            await Promise.allSettled(files.map((file, i) => promiseFileAsText(file).then((text) => {
                const data = JSON.parse(text);
                const profileIndex = profileIndices[i];

                for (const entry in data) {
                    if (!(data[entry] instanceof Object && "criteria" in data[entry])) continue;
                    for (const criterion in data[entry].criteria) {
                        const dateString = data[entry].criteria[criterion];
                        const date = new Date(dateString);

                        let event = "";
                        if (criterion == "has_the_recipe") {
                            event = entry.replace(/\w+:recipes\/\w+\/(\w+)/, "Has recipe: $1")
                        } else if (!entry.startsWith('minecraft')) {
                            if (criterion.startsWith('has') && criterion !== "has_ingredient" && !criterion.startsWith("has_item")) {
                                event = criterion;
                            } else {
                                const match = entry.match(/^(\w+):.*?\/(\w+)$/);
                                if (match) {
                                    if (match[2] == criterion) {
                                        event = `${match[1]}:${match[2]}`
                                    } else {
                                        event = `${match[1]}:${match[2]}, ${criterion}`
                                    }
                                } else {
                                    event = `${entry},${criterion}`;
                                }
                            }
                        } else if (criterion == "has_double_plant") {
                            event = entry.replace(/\w+:recipes\/\w+\/(\w+)/, "Learned: $1");
                        } else if (entry == "minecraft:adventure/adventuring_time" || entry == "minecraft:nether/explore_nether") {
                            event = criterion.replace(/^minecraft:(\w+)$/, "Biome: $1");
                        } else if (entry == "minecraft:husbandry/balanced_diet") {
                            event = `Ate: ${criterion}`;
                        } else if (entry == "minecraft:husbandry/whole_pack") {
                            event = criterion.replace(/^minecraft:(\w+)$/, "tamed wolf: $1");
                        } else if (entry == "minecraft:husbandry/leash_all_frog_variants") {
                            event = criterion.replace(/^minecraft:(\w+)$/, "led frog: $1");
                        } else if (entry == "minecraft:husbandry/breed_an_animal") {
                            event = "bred animal";
                        } else if (entry == "minecraft:nether/brew_potion") {
                            event = "brew potion";
                        } else if (entry == "minecraft:husbandry/bred_all_animals") {
                            event = criterion.replace(/^minecraft:(\w+)$/, "bred: $1");
                        } else if (entry == "minecraft:adventure/kill_all_mobs" || entry == "minecraft:adventure/kill_a_mob") {
                            event = criterion.replace(/^minecraft:(\w+)$/, "Killed: $1");
                        } else if (entry == "minecraft:husbandry/plant_seed") {
                            event = `Planted first crop: ${criterion}`;
                        } else {
                            event = criterion;
                        }

                        event = event.replace("_", "\u200B_\u200B");
                        timeline.push([date, profileIndex, event]);
                    }
                }
            })));
            timeline.sort((a, b) => a[2].localeCompare(b[2])).sort((a, b) => a[0] - b[0]);
            removeDuplicateEvents(timeline);

            await usernamesPromise;
        }


        function focusDetailsIfWentOffscreen(event) {
            const detailsEl = event.currentTarget.parentNode;
            if (detailsEl.open) {
                event.preventDefault();
                detailsEl.open = false;

                const margin = parseFloat(getComputedStyle(event.currentTarget).top) + parseFloat(getComputedStyle(event.currentTarget.firstElementChild).marginTop);
                if (event.target.getBoundingClientRect().y < margin) {
                    event.target.scrollIntoView();
                    window.scrollBy(0, -margin);
                }
            }
        }


        function timelinePrint() {
            if (timeline.length <= 0) return;

            styleEl.innerText = profiles.map((profile, i) =>
                `.p${i} {color: hsl(${i / profiles.length}turn 100% 50%);} a.p${i}:hover {color: hsl(${i / profiles.length}turn 75% 75%);}`).join(" ");

            timelineDivOuter.removeAttribute("hidden");
            timelineDiv.replaceChildren();

            let prevDate = new Date(0);
            let currentDateEl = null;
            let currentHourEl = null;
            let currentTimeEl = null;
            for (let i = 0; i < timeline.length; i++) {
                const event = timeline[i];
                const date = event[0];
                if (!sameDay(date, prevDate)) {
                    // different day

                    const dateSummaryEl = document.createElementEX("summary", {}, [
                        document.createElementEX("h2", {}, [
                            DateFormat.format(date)
                        ])
                    ]);
                    const dateDetailsEl = document.createElementEX("details", { "open": "", "id": `date${i}` }, [dateSummaryEl]);
                    dateSummaryEl.addEventListener("click", focusDetailsIfWentOffscreen);
                    timelineDiv.appendChild(dateDetailsEl);
                    currentDateEl = dateDetailsEl;
                }
                const hour = date.getHours();
                if (!sameDay(date, prevDate) || hour !== prevDate.getHours()) {
                    // different hour

                    const hourSummaryEl = document.createElementEX("summary", {}, [
                        document.createElementEX("h3", {}, [
                            `${(hour + 11) % 12 + 1} ${hour >= 12 ? "PM" : "AM"}`
                        ])
                    ]);
                    const hourListEl = document.createElement("ul");
                    const hourDetailsEl = document.createElementEX("details", { "open": "", "id": `hour${i}` }, [
                        hourSummaryEl,
                        hourListEl
                    ])
                    hourSummaryEl.addEventListener("click", focusDetailsIfWentOffscreen);
                    currentDateEl.appendChild(hourDetailsEl);
                    currentHourEl = hourListEl;
                }

                const profileIndex = event[1];
                const profile = profiles[profileIndex];

                let eventItemEl = document.createElement("li");

                if (!currentTimeEl || date.getTime() !== prevDate.getTime()) {
                    // different instance of time

                    const timestampEl = document.createElementEX("b", {}, [DateTimeFormat.format(date) + " "]);
                    eventItemEl.appendChild(timestampEl);

                    if (i + 1 < timeline.length && date.getTime() === timeline[i + 1][0].getTime()) {
                        // current time instant has multiple events

                        const timeListEl = document.createElement("ul");
                        eventItemEl.appendChild(timeListEl);
                        currentTimeEl = timeListEl;

                        currentHourEl.appendChild(eventItemEl);
                        eventItemEl = document.createElement("li");
                    } else {
                        // current time instant only has one event
                        currentTimeEl = null;
                    }
                }


                const spanEl = !profile.generated ?
                    document.createElementEX("a", {
                        "href": `https://namemc.com/profile/${profile.uuid}`,
                        "target": "_blank"
                    }, [profile.username])
                    : document.createElementEX("span", {}, [profile.username]);
                spanEl.setAttribute("title", profile.uuid);
                spanEl.setAttribute("class", `p${profile.nameless ? " pn" : ""} p${profileIndex}`);

                const eventEl = document.createTextNode(" " + event[2]);

                eventItemEl.appendChild(spanEl);
                eventItemEl.appendChild(eventEl);

                (currentTimeEl || currentHourEl).appendChild(eventItemEl);

                prevDate = date;
            }
        }
    </script>

</body>

</html>