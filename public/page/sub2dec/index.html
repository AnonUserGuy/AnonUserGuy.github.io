<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Convert Rhythm Heaven subroutine RAM pointers to ROM offsets!">
    <meta name="keywords" content="Rhythm Heaven Modding">
    <meta name="author" content="AnonUserGuy">

    <meta property="og:title" content="Sub to Offset Converter">
    <meta property="og:description" content="Convert Rhythm Heaven subroutine RAM pointers to ROM offsets!">
    <meta property="og:image" content="https://anonuserguy.github.io/media/images/girl.jpg">
    <meta property="og:url" content="https://anonuserguy.github.io/page/sub2dec/">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Sub to Offset Converter</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/js/global.js"></script>
</head>

<body>
    <div>
        <a href="/">&lt-- go back</a>
    </div>

    <div class="section">
        <h2>Original</h2>
        <div class="text-entries">
            <div>
                <label for="subOG">Sub: </label> 
                <input type="text" id="subOG" value="60 FA 28 02" onkeyup="subInput()">
            </div>
            <div>
                <label for="offOG">Offset: </label> 
                <input type="text" id="offOG" value="0" onkeyup="offsetInput()">
            </div>
        </div>
        <p>
            <input type="checkbox" id="littleEndian" checked="true" onchange="autoInput()">
            <label for="littleEndian">Little Endian?</label>
        </p>
    </div>

    <div class="section">
        <h2>Find</h2>
        <div class="text-entries">
            <div>
                <label for="sub">Sub: </label>
                <input type="text" id="sub" value="" onkeyup="subInput()">
            </div>
            <div>
                <label for="offset">Offset: </label> 
                <input type="text" id="offset" value="0" onkeyup="offsetInput()">
            </div>
        </div>
        <p>
            <button onclick="subInput()">Convert to Offset</button>
            <button onclick="offsetInput()">Convert to Sub</button>
        </p>
    </div>

    <div class="section">
        <h2>Presets</h2>
        <div class="selector">
            <p>
                <input type="radio" id="gba" name="preset" value="0" onchange="preset()" checked="false">
                <label for="gba">Rhythm Tengoku (GBA)</label>
            </p>
            <p>
                <input type="radio" id="nds" name="preset" value="1" onchange="preset()" checked="false">
                <label for="nds">Rhythm Heaven (NDS) (NA)</label>
            </p>
            <p>
                <input type="radio" id="wii" name="preset" value="2" onchange="preset()" checked="false">
                <label for="wii">Rhythm Heaven Fever (Wii) (NA)</label>
            </p>
        </div>
    </div>

    <div>
        <p><img src="/media/images/girl.jpg" alt="girl" height="120"></p>
        <p>brought to you by <strong>Rhythm Heaven</strong></p>
    </div>

    <script>
        var listOld = [
            ["2C 2A 9F 08", "9F2A2C", true, "GBA"], //GBA uses 0D 00 00 00 XX XX XX XX to call subs, something the docs don't mention
            ["B8 0A 29 02", "1058", true, "NDS"],
            ["80 21 7D E0", "213EE0", false, "WII"]
        ];
        var list = [
            ["00 00 00 08", "0", true, "GBA"],
            ["60 FA 28 02", "0", true, "NDS"],
            ["80 00 3F 00", "0", false, "WII"]
        ]
        var lastInput = "offset";
        preset()
        function subInput() {
            var sub = document.getElementById("sub").value;
            var subOg = document.getElementById("subOG").value;
            var offOg = document.getElementById("offOG").value;
            var lilEndian = document.getElementById("littleEndian").checked;
            document.getElementById("offset").value = findOffset(sub, subOg, offOg, lilEndian);
            lastInput = "sub";
        }
        function offsetInput() {
            var offset = document.getElementById("offset").value;
            var subOg = document.getElementById("subOG").value;
            var offOg = document.getElementById("offOG").value;
            var lilEndian = document.getElementById("littleEndian").checked;
            document.getElementById("sub").value = findSub(offset, subOg, offOg, lilEndian);
            lastInput = "offset";
        }
        function autoInput() {
            if (lastInput === "sub") {
                subInput();
            } else {
                offsetInput();
            }
        }

        function preset() {
            var whom = document.querySelector('input[name="preset"]:checked').value;
            var set = list[whom];
            document.getElementById("subOG").value = set[0];
            document.getElementById("offOG").value = set[1];
            document.getElementById("littleEndian").checked = set[2];
            autoInput()
        }

        function sub2dec(input, littleEndian = true) {
            if (typeof (input) === 'string') {
                if (littleEndian) {
                    var result = parseInt(input.split(" ").reverse().join(""), 16);
                } else {
                    var result = parseInt(input.split(" ").join(""), 16);
                }
            } else {
                var result = input.toString(16).toUpperCase();
                if (result.length % 2 === 1) {
                    result = "0" + result;
                }
                if (littleEndian) {
                    result = result.match(/.{1,2}/g).reverse().join(" ");
                } else {
                    result = result.match(/.{1,2}/g).join(" ");
                }
            }
            return (result);
        }

        function findOffset(subED, subOG, offsetOG, littleEndian) {
            const decSubOG = sub2dec(subOG, littleEndian);
            const decSubED = sub2dec(subED, littleEndian);
            const decOffsetOG = parseInt(offsetOG, 16);
            const decOffsetED = decOffsetOG + decSubED - decSubOG;
            const offsetED = decOffsetED.toString(16).toUpperCase();
            return (offsetED);
        }

        function findSub(offsetED, subOG, offsetOG, littleEndian) {
            const decOffsetOG = parseInt(offsetOG, 16);
            const decOffsetED = parseInt(offsetED, 16);
            const decSubOG = sub2dec(subOG, littleEndian);
            const decSubED = decSubOG + decOffsetED - decOffsetOG;
            const subED = sub2dec(decSubED, littleEndian);
            return (subED);
        }
    </script>

</body>

</html>